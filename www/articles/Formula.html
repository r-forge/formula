<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extended Model Formulas in R: Multiple Parts and Multiple Responses • Formula</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Extended Model Formulas in R: Multiple Parts and Multiple Responses">
<meta property="og:description" content="Formula">
<meta property="og:image" content="https://Formula.R-Forge.R-project.org/logo.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@AchimZeileis">
<meta name="twitter:site" content="@AchimZeileis">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Formula</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2-6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/Formula.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extended Model Formulas in R: Multiple Parts and
Multiple Responses</h1>
                        <h4 data-toc-skip class="author">Achim
Zeileis</h4>
            <address class="author_afil">
      Universität
Innsbruck<br><a class="author_email" href="mailto:#"></a><a href="mailto:Achim.Zeileis@R-project.org" class="email">Achim.Zeileis@R-project.org</a>
      </address>
                              <h4 data-toc-skip class="author">Yves
Croissant</h4>
            <address class="author_afil">
      Université de la
Réunion<br><a class="author_email" href="mailto:#"></a><a href="mailto:Yves.Croissant@univ-reunion.fr" class="email">Yves.Croissant@univ-reunion.fr</a>
      </address>
                  
      
      
      <div class="hidden name"><code>Formula.Rmd</code></div>

    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>This introduction to the R package <strong>Formula</strong> is
      a (slightly) modified version of <span class="citation">Zeileis
      and Croissant (2010)</span>, published in the <em>Journal of
      Statistical Software</em>. Model formulas are the standard
      approach for specifying the variables in statistical models in the
      S language. Although being eminently useful in an extremely wide
      class of applications, they have certain limitations including
      being confined to single responses and not providing convenient
      support for processing formulas with multiple parts. The latter is
      relevant for models with two or more sets of variables, e.g.,
      different equations for different model parameters (such as mean
      and dispersion), regressors and instruments in instrumental
      variable regressions, two-part models such as hurdle models, or
      alternative-specific and individual-specific variables in choice
      models among many others. The R package <strong>Formula</strong>
      addresses these two problems by providing a new class
      <code>"Formula"</code> (inheriting from <code>"formula"</code>)
      that accepts an additional formula operator <code>|</code>
      separating multiple parts and by allowing all formula operators
      (including the new <code>|</code>) on the left-hand side to
      support multiple responses.</p>
    </div>
    
<div class="section level2">
<h2 id="sec:intro">Introduction<a class="anchor" aria-label="anchor" href="#sec:intro"></a>
</h2>
<p>Since publication of the seminal “white book” <span class="citation">(Chambers and Hastie 1992)</span> the standard approach
for fitting statistical models in the S language is to apply some
model-fitting function (such as <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> or <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>)
to a <code>"formula"</code> description of the variables involved in the
model and typically stored in a <code>"data.frame"</code>. The semantics
of formula processing are based on the ideas of the <span class="citation">Wilkinson and Rogers (1973)</span> notation which in
turn was targeted at specification of analysis of variance models.
Despite this emphasis on specification of terms in models with linear
predictors, formula notation has always been used much more generally in
S, e.g., for specifying variables in classification and regression
trees, margins in contingency tables, or variables in graphical
displays. In such applications, the precise meaning of a particular
formula depends on the function that processes it. Typically, the
standard formula processing approach would encompass extraction of the
specified terms using <code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms()</a></code>, preparation of a
preprocessed data frame using <code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code>, and
computation of a “design” or “regressor” matrix using
<code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>. However, there are certain limitations to
these standard formula processing tools in S that can be rather
inconvenient in certain applications:</p>
<ul>
<li>The formula notation can just be used on the right-hand side (RHS)
of a formula (to the right of the <code>~</code>) while it has its
original arithmetic meaning on the left-hand side (LHS). This makes it
difficult to specify multiple responses, especially if these are not
numeric (e.g., factors). This feature would be useful for specifying
multivariate outcomes of mixed types in independence tests <span class="citation">Hothorn et al. (2008)</span> or in models with
multivariate responses <span class="citation">(e.g., supported in the
<strong>party</strong> package, Zeileis, Hothorn, and Hornik
2008)</span>.</li>
<li>There is no simple construct in standard formula notation that
allows one to separate several groups of variables from which separate
model matrices can be derived. This task occurs in many types of models,
e.g., when processing separate sets of variables for mean and dispersion
<span class="citation">(e.g., in the <strong>betareg</strong> package,
Cribari-Neto and Zeileis 2010)</span>, separate equations for location,
scatter, and shape <span class="citation">(e.g., in the
<strong>gamlss</strong> package, Stasinopoulos and Rigby 2007)</span>,
regressors and instruments in instrumental variable regressions <span class="citation">Kleiber and Zeileis (2008)</span>, variables in
two-part models such as hurdle models or zero-inflated regressions <span class="citation">(e.g., in the <strong>pscl</strong> package, Zeileis,
Kleiber, and Jackman 2008)</span>, alternative-specific and
individual-specific variables in choice models <span class="citation">(e.g., in the <strong>mlogit</strong> package,
Croissant 2010)</span>, efficiency level variables in stochastic
frontier analysis <span class="citation">(e.g., in the
<strong>frontier</strong> package, Coelli and Henningsen 2010)</span>,
or modeling variables and partitioning variables in model-based
recursive partitioning techniques <span class="citation">(e.g., in the
<strong>party</strong> package, Zeileis, Hothorn, and Hornik
2008)</span>.</li>
</ul>
<p>In many of the aformentioned packages, standard
<code>"formula"</code> objects are employed but their processing is
generalized, e.g., by using multiple formulas, multiple terms, by adding
new formula operators or even more elaborate solutions. However, in many
situations it is not easy to reuse these generalizations outside the
package/function they were designed for. Therefore, as we repeatedly
needed such generalizations in our own packages and addressed this in
the past by various different solutions, it seemed natural to provide a
more general unified approach by means of our new
<strong>Formula</strong> package. This has already been reused in some
of our own packages (including <strong>AER</strong>,
<strong>betareg</strong>, <strong>mlogit</strong>, and
<strong>plm</strong>) but can also be easily employed by other package
developers (e.g., as in the <strong>frontier</strong> package). More
applications in our own and other packages will hopefully follow.</p>
<p>In the remainder of this paper we discuss how multiple responses and
multiple parts (both on the LHS and RHS) are enabled in the
<strong>Formula</strong> package written in the R system for statistical
computing <span class="citation">(R Core Team 2009)</span> and available
from the Comprehensive R Archive Network (CRAN) at <a href="https://CRAN.R-project.org/package=Formula" class="external-link uri">https://CRAN.R-project.org/package=Formula</a>. Built on top
of basic <code>"formula"</code> objects, the <code>"Formula"</code>
class just adds a thin additional layer which is based on a single
additional operator, namely <code>|</code>, that can be used to separate
different parts (or groups) of variables. <strong>Formula</strong>
essentially just handles the different formula parts and leverages the
existing methods for <code>"formula"</code> objects for all remaining
operations. (Throughout the paper, no terminological distinction is made
between classic <code>"formula"</code> objects as such and the way they
are interpreted by standard processing tools (e.g.,
<code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms()</a></code>, <code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code>,
<code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>). The reasons for this are twofold: First,
it reflects their use as described in <span class="citation">Chambers
and Hastie (1992)</span> and, second, generalizations generally require
extra effort from the user.) In the <a href="#sec:motivation">“Motivating examples”</a> we show the main ideas
implemented in the package and how easily they can be employed. The
details of the <code>"Formula"</code> class and its associated methods
are discussed in the <a href="#sec:implementation">“Implementation”</a>
section and the <a href="#sec:usage">“Usage in model fitting
functions”</a> illustrates how <strong>Formula</strong> can be used in
the development of new functions/packages. A short <a href="#sec:summary">“Summary”</a> concludes the paper.</p>
</div>
<div class="section level2">
<h2 id="sec:motivation">Motivating examples<a class="anchor" aria-label="anchor" href="#sec:motivation"></a>
</h2>
<p>To illustrate the basic ideas of the <strong>Formula</strong>
package, we first generate a small artificial data set (with both
numeric and categorical variables) and subsequently illustrate its usage
with a multi-part and a multi-response <code>"Formula"</code>,
respectively.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1090</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">21</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y1"</span>, <span class="st">"y2"</span>, <span class="st">"y3"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>, <span class="st">"x4"</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="va">dat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.5</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">y2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">dat</span></span>
<span><span class="co">##     y1   y2   y3   x1   x2 x3 x4</span></span>
<span><span class="co">## 1 0.82 &lt;NA&gt; 0.27 0.09 0.22  a  b</span></span>
<span><span class="co">## 2 0.70    a 0.17 0.26 0.46  b  b</span></span>
<span><span class="co">## 3 0.65    b 0.28 0.03 0.37  a  a</span></span></code></pre></div>
<div class="section level3">
<h3 id="multiple-parts">Multiple parts<a class="anchor" aria-label="anchor" href="#multiple-parts"></a>
</h3>
<p>We start out with a simple formula
<code>log(y1) ~ x1 + x2 | I(x1^2)</code> which has a single response
<code>log(y1)</code> on the LHS and two parts on the RHS, separated by
<code>|</code>. The first part contains <code>x1</code> and
<code>x2</code>, the second contains <code>I(x1^2)</code>, i.e., the
squared values of <code>x1</code>. The initial <code>"formula"</code>
can be transformed to a <code>"Formula"</code> using the constructor
function <code><a href="../reference/Formula.html">Formula()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">F1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Formula.html">Formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">x1</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">F1</span><span class="op">)</span></span>
<span><span class="co">## [1] 1 2</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code> method indicates that there is one part on
the LHS and two parts on the RHS. The first step of processing data
using a formula is typically the construction of a so-called model frame
containing only the variables required by the formula. As usual, this
can be obtained with the <code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code> method.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mf1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">F1</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">mf1</span></span>
<span><span class="co">##      log(y1)   x1   x2 I(x1^2)</span></span>
<span><span class="co">## 1 -0.1984509 0.09 0.22  0.0081</span></span>
<span><span class="co">## 2 -0.3566749 0.26 0.46  0.0676</span></span>
<span><span class="co">## 3 -0.4307829 0.03 0.37   9e-04</span></span></code></pre></div>
<p>As this model just has a single response (as in base
<code>"formula"</code> objects), the extractor function
<code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response()</a></code> can be employed:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response</a></span><span class="op">(</span><span class="va">mf1</span><span class="op">)</span></span>
<span><span class="co">##          1          2          3 </span></span>
<span><span class="co">## -0.1984509 -0.3566749 -0.4307829</span></span></code></pre></div>
<p>For constructing separate model matrices for the two parts on the
RHS, the <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code> can be employed and additionally
specifying the argument <code>rhs</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">F1</span>, data <span class="op">=</span> <span class="va">mf1</span>, rhs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">##   (Intercept)   x1   x2</span></span>
<span><span class="co">## 1           1 0.09 0.22</span></span>
<span><span class="co">## 2           1 0.26 0.46</span></span>
<span><span class="co">## 3           1 0.03 0.37</span></span>
<span><span class="co">## attr(,"assign")</span></span>
<span><span class="co">## [1] 0 1 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">F1</span>, data <span class="op">=</span> <span class="va">mf1</span>, rhs <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##   (Intercept) I(x1^2)</span></span>
<span><span class="co">## 1           1  0.0081</span></span>
<span><span class="co">## 2           1  0.0676</span></span>
<span><span class="co">## 3           1  0.0009</span></span>
<span><span class="co">## attr(,"assign")</span></span>
<span><span class="co">## [1] 0 1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multiple-responses">Multiple responses<a class="anchor" aria-label="anchor" href="#multiple-responses"></a>
</h3>
<p>To accommodate multiple responses, all formula operators can be
employed on the LHS in <code>"Formula"</code> objects (whereas they
would have their original arithmetic meaning in <code>"formula"</code>
objects). This also includes the new <code>|</code> operator for
separating different parts. Thus, one could specify a two-part response
via <code>y1 | y2 ~ x3</code> or a single part with two variables via
<code>y1 + y2 ~ x3</code>. We do the latter in the following
illustration.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">F2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Formula.html">Formula</a></span><span class="op">(</span><span class="va">y1</span> <span class="op">+</span> <span class="va">y2</span> <span class="op">~</span> <span class="va">x3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">F2</span><span class="op">)</span></span>
<span><span class="co">## [1] 1 1</span></span></code></pre></div>
<p>As usual, the model frame can be derived by</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mf2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">F2</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">mf2</span></span>
<span><span class="co">##     y1 y2 x3</span></span>
<span><span class="co">## 2 0.70  a  b</span></span>
<span><span class="co">## 3 0.65  b  a</span></span></code></pre></div>
<p>However, there is an important difference to the model frame
<code>mf1</code> derived in the previous example. As the (non-generic)
<code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response()</a></code> function would only be able to extract a
single response column from a model frame, multi-response model frames
in <strong>Formula</strong> are implemented to have no response at all
in the <code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response()</a></code> sense:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response</a></span><span class="op">(</span><span class="va">mf2</span><span class="op">)</span></span>
<span><span class="co">## NULL</span></span></code></pre></div>
<p>As <code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response()</a></code> cannot be extended (without
overloading the base R function), <strong>Formula</strong> provides a
new generic function <code><a href="../reference/model.frame.Formula.html">model.part()</a></code> which can be used to
extract all variables from a model frame pertaining to specific parts.
This can also be used to extract multiple responses. Its syntax is
modeled after <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code> taking a
<code>"Formula"</code> as the first argument. For further details see
the <a href="#sec:implementation">“Implementation”</a> section. Its
application is straightforward and all LHS variables (in the first and
only part of the LHS) can be extracted via</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/model.frame.Formula.html">model.part</a></span><span class="op">(</span><span class="va">F2</span>, data <span class="op">=</span> <span class="va">mf2</span>, lhs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">##     y1 y2</span></span>
<span><span class="co">## 2 0.70  a</span></span>
<span><span class="co">## 3 0.65  b</span></span></code></pre></div>
<p>The same method also works for single response models as in the
previous example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/model.frame.Formula.html">model.part</a></span><span class="op">(</span><span class="va">F1</span>, data <span class="op">=</span> <span class="va">mf1</span>, lhs <span class="op">=</span> <span class="fl">1</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">##          1          2          3 </span></span>
<span><span class="co">## -0.1984509 -0.3566749 -0.4307829</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="sec:implementation">Implementation<a class="anchor" aria-label="anchor" href="#sec:implementation"></a>
</h2>
<p>Below we discuss the ideas for the design of the
<code>"Formula"</code> class and methods. As all tools are built on top
of the <code>"formula"</code> class and its associated methods whose
most important feature are briefly outlined as well.</p>
<div class="section level3">
<h3 id="working-with-classic-formula-objects">Working with classic <code>"formula"</code> objects<a class="anchor" aria-label="anchor" href="#working-with-classic-formula-objects"></a>
</h3>
<p>Classic <code>"formula"</code> objects <span class="citation">(Chambers and Hastie 1992)</span> are constructed by
using <code>~</code> to separate LHS and RHS, typically (but not
necessarily) interpreted as “dependent” and “explanatory” variables. For
describing relationships between variables on the RHS, several operators
can be used: <code>+</code>, <code>-</code>, <code>*</code>,
<code>/</code>, <code>:</code>, <code>%in%</code>, <code>^</code>. Thus,
these do not have their original meaning in the top-level RHS while they
keep their original arithmetic meaning on higher levels of the RHS
(thus, within function calls such as <code>I(x1^2)</code>) and on the
LHS in general. A first step in using <code>"formula"</code> objects is
often to compute the associated <code>"terms"</code> using the function
<code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms()</a></code>. Based on the formula or the associated terms and a
suitable set of variables (typically either in a data frame or in the
global environment) <code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code> can build a so-called
model frame that contains all variables in the formula/terms. This might
include processing of missing values (<code>NA</code>s), carrying out
variable transformations (such as logs, squares, or other functions of
one or more variables) and providing further variables like weights,
offset, etc. A model frame is simply a <code>"data.frame"</code> with
additional attributes (including <code>"terms"</code>) but without a
specific class. From this preprocessed model frame several components
can be extracted using <code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.extract()</a></code> or
<code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response()</a></code>, <code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.weights()</a></code>, and
<code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.offset()</a></code>, all of which are non-generic. Last not
least, <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code> (which is generic) can compute
“design” or “regressor” matrices based on the formula/terms and the
associated model frame.</p>
</div>
<div class="section level3">
<h3 id="constructing-formula-objects">Constructing <code>"Formula"</code> objects<a class="anchor" aria-label="anchor" href="#constructing-formula-objects"></a>
</h3>
<p>To accomplish the main objectives of the <code>"Formula"</code>
class, the following design principles have been used: reuse of
<code>"formula"</code> objects, introduction of a single new operator
<code>|</code>, and support of all formula operators on the LHS. Thus,
<code>|</code> loses its original meaning (logical “or”) on the first
level of formulas but can still be used with its original meaning on
higher levels, e.g., <code>factor(x1 &gt; 0.5 | x3 == "a")</code> still
works as before. For assigning a new class to formulas containing
<code>|</code>, the constructor function <code><a href="../reference/Formula.html">Formula()</a></code> is
used:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">F3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Formula.html">Formula</a></span><span class="op">(</span><span class="va">y1</span> <span class="op">+</span> <span class="va">y2</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y3</span><span class="op">)</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">x2</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">|</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">|</span> <span class="va">x3</span> <span class="op">/</span> <span class="va">x4</span><span class="op">)</span></span>
<span><span class="va">F3</span></span>
<span><span class="co">## y1 + y2 | log(y3) ~ x1 + I(x2^2) | 0 + log(x1) | x3/x4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">F3</span><span class="op">)</span></span>
<span><span class="co">## [1] 2 3</span></span></code></pre></div>
<p>In this example, <code>F3</code> is an artificially complex formula
with two parts on the LHS and three parts on the RHS, both containing
multiple terms, transformations or other formula operators. Apart from
assigning the new class <code>"Formula"</code> (in addition to the old
<code>"formula"</code> class), <code><a href="../reference/Formula.html">Formula()</a></code> also splits up the
formula into LHS and RHS parts which are stored as list attributes
<code>"lhs"</code> and <code>"rhs"</code>, respectively, e.g.,</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">F3</span>, <span class="st">"lhs"</span><span class="op">)</span></span>
<span><span class="co">## [[1]]</span></span>
<span><span class="co">## y1 + y2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## log(y3)</span></span></code></pre></div>
<p>and analogously <code>attr(F3, "rhs")</code>. The user never has to
compute on these attributes directly, but many methods for
<code>"Formula"</code> objects take <code>lhs</code> and/or
<code>rhs</code> arguments. These always refer to index vectors for the
two respective lists.</p>
<p>It would have been conceivable to generalize not only the notion of
formulas but also of terms or model frames. However, there are few
generics with methods for <code>"terms"</code> objects and there is no
particular class for model frames at all. Hence, computing with
generalized versions of these concepts would have required much more
overhead for users of <strong>Formula</strong>. Hence, it was decided
not to do so and keep the package interface as simple as possible.</p>
</div>
<div class="section level3">
<h3 id="extracting-formula-and-terms-objects">Extracting <code>"formula"</code> and <code>"terms"</code>
objects<a class="anchor" aria-label="anchor" href="#extracting-formula-and-terms-objects"></a>
</h3>
<p>As subsequent computations typically require a <code>"formula"</code>
or a <code>"terms"</code> object, <strong>Formula</strong> provides
suitable <code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula()</a></code> and <code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms()</a></code> extractors for
<code>"Formula"</code> objects. For the former, the idea is to be able
to switch back and forth between the <code>"Formula"</code> and
<code>"formula"</code> representation, e.g.,
<code>formula(Formula(...))</code> should recover the original input
formula. For the latter, the objective is somewhat different:
<code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms()</a></code> should always return a <code>"terms"</code> object
that can be processed by <code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code> and similar
functions. Thus, the terms must not contain multiple responses and/or
the new <code>|</code> operator.</p>
<p>The <code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula()</a></code> method is straightforward. When no
additional arguments are supplied it recovers the original
<code>"formula"</code>. Furthermore, there are two optional additional
arguments <code>lhs</code> and <code>rhs</code>. With these arguments
subsets of formulas can be chosen, indexing the LHS and RHS parts. The
default value for both is <code>NULL</code>, meaning that all parts are
employed.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">F3</span><span class="op">)</span></span>
<span><span class="co">## y1 + y2 | log(y3) ~ x1 + I(x2^2) | 0 + log(x1) | x3/x4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">F3</span>, lhs <span class="op">=</span> <span class="fl">2</span>, rhs <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## log(y3) ~ x1 + I(x2^2) | x3/x4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">F3</span>, lhs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, rhs <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## y1 + y2 ~ 0</span></span></code></pre></div>
<p>Similarly, <code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms()</a></code> computes a <code>"terms"</code>
object, by default using all parts in the formula, but <code>lhs</code>
and <code>rhs</code> can be used as above. To remove the <code>|</code>
operator, all parts are collapsed using the <code>+</code> operator.
Furthermore, the LHS variables can only be kept on the LHS if they
contain a single term. Otherwise, to stop subsequent computations from
interpreting the formula operators as arithmetic operators, all LHS
components are added on the RHS as well. Thus, for <code>F3</code> we
obtain</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">F3</span><span class="op">)</span></span>
<span><span class="co">## ~y1 + y2 + log(y3) + (x1 + I(x2^2)) + (0 + log(x1)) + x3/x4</span></span>
<span><span class="co">## attr(,"variables")</span></span>
<span><span class="co">## list(y1, y2, log(y3), x1, I(x2^2), log(x1), x3, x4)</span></span>
<span><span class="co">## attr(,"factors")</span></span>
<span><span class="co">##         y1 y2 log(y3) x1 I(x2^2) log(x1) x3 x3:x4</span></span>
<span><span class="co">## y1       1  0       0  0       0       0  0     0</span></span>
<span><span class="co">## y2       0  1       0  0       0       0  0     0</span></span>
<span><span class="co">## log(y3)  0  0       1  0       0       0  0     0</span></span>
<span><span class="co">## x1       0  0       0  1       0       0  0     0</span></span>
<span><span class="co">## I(x2^2)  0  0       0  0       1       0  0     0</span></span>
<span><span class="co">## log(x1)  0  0       0  0       0       1  0     0</span></span>
<span><span class="co">## x3       0  0       0  0       0       0  1     2</span></span>
<span><span class="co">## x4       0  0       0  0       0       0  0     1</span></span>
<span><span class="co">## attr(,"term.labels")</span></span>
<span><span class="co">## [1] "y1"      "y2"      "log(y3)" "x1"      "I(x2^2)" "log(x1)" "x3"     </span></span>
<span><span class="co">## [8] "x3:x4"  </span></span>
<span><span class="co">## attr(,"order")</span></span>
<span><span class="co">## [1] 1 1 1 1 1 1 1 2</span></span>
<span><span class="co">## attr(,"intercept")</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## attr(,"response")</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## attr(,".Environment")</span></span>
<span><span class="co">## &lt;environment: R_GlobalEnv&gt;</span></span></code></pre></div>
<p>Instead of using all parts, subsets can again be selected. We
illustrate this below but only show the associated
<code>"formula"</code> to save output space:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">F3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## ~y1 + y2 + log(y3) + (x1 + I(x2^2)) + (0 + log(x1)) + x3/x4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">F3</span>, lhs <span class="op">=</span> <span class="fl">2</span>, rhs <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## log(y3) ~ x1 + I(x2^2) + x3/x4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">F3</span>, lhs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, rhs <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## ~y1 + y2</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-model-frames-matrices-and-responses">Computing model frames, matrices, and responses<a class="anchor" aria-label="anchor" href="#computing-model-frames-matrices-and-responses"></a>
</h3>
<p>Given that suitable <code>"terms"</code> can be extracted from
<code>"Formula"</code> objects, it is straightforward to set up the
corresponding model frame. The <code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code> method simply
first calls the <code><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms()</a></code> method and then applies the default
<code><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame()</a></code>. Hence, all further arguments are processed
as usual, e.g.,</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mf3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">F3</span>, data <span class="op">=</span> <span class="va">dat</span>, subset <span class="op">=</span> <span class="va">y1</span> <span class="op">&lt;</span> <span class="fl">0.75</span>, weights <span class="op">=</span> <span class="va">x1</span><span class="op">)</span></span>
<span><span class="va">mf3</span></span>
<span><span class="co">##     y1 y2   log(y3)   x1 I(x2^2)   log(x1) x3 x4 (weights)</span></span>
<span><span class="co">## 2 0.70  a -1.771957 0.26  0.2116 -1.347074  b  b      0.26</span></span>
<span><span class="co">## 3 0.65  b -1.272966 0.03  0.1369 -3.506558  a  a      0.03</span></span></code></pre></div>
<p>All subsequent computations are then based on this preprocessed model
frame (and possibly the original <code>"Formula"</code>). Thus, the
model matrices for each RHS part can be easily computed, again setting
the <code>rhs</code> argument:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">F3</span>, data <span class="op">=</span> <span class="va">mf3</span>, rhs <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##     log(x1)</span></span>
<span><span class="co">## 2 -1.347074</span></span>
<span><span class="co">## 3 -3.506558</span></span>
<span><span class="co">## attr(,"assign")</span></span>
<span><span class="co">## [1] 1</span></span></code></pre></div>
<p>Typically, just a single RHS will be selected and hence
<code>rhs = 1</code> and not <code>rhs = NULL</code> is the default in
this method. However, multiple RHS parts are also supported. Also, there
is a <code>lhs</code> argument available (defaulting to
<code>NULL</code>) which might seem unnecessary at first sight but it is
important in case the selected RHS part(s) contain(s) a “<code>.</code>”
that needs to be resolved (see <code><a href="../reference/model.frame.Formula.html">?model.matrix.Formula</a></code> for an
example).</p>
<p>The LHS parts can be extracted using the method for the new
<code><a href="../reference/model.frame.Formula.html">model.part()</a></code> generic, employing a syntax similar to
<code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/model.frame.Formula.html">model.part</a></span><span class="op">(</span><span class="va">F3</span>, data <span class="op">=</span> <span class="va">mf3</span>, lhs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">##     y1 y2</span></span>
<span><span class="co">## 2 0.70  a</span></span>
<span><span class="co">## 3 0.65  b</span></span>
<span><span class="fu"><a href="../reference/model.frame.Formula.html">model.part</a></span><span class="op">(</span><span class="va">F3</span>, data <span class="op">=</span> <span class="va">mf3</span>, lhs <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##     log(y3)</span></span>
<span><span class="co">## 2 -1.771957</span></span>
<span><span class="co">## 3 -1.272966</span></span></code></pre></div>
<p>As argued above, introduction of a new generic is necessary for
supporting multi-response formulas because <code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response()</a></code>
is non-generic. For model frames derived from single-response formulas,
<code><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response()</a></code> can be used as usual. The remaining
extractors work as usual:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.weights</a></span><span class="op">(</span><span class="va">mf3</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.26 0.03</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="further-methods">Further methods<a class="anchor" aria-label="anchor" href="#further-methods"></a>
</h3>
<p>To conclude the suite of methods available for the new
<code>"Formula"</code> class, <strong>Formula</strong> provides an
<code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> method and a new <code><a href="../reference/Formula.html">as.Formula()</a></code> generic
with suitable methods. The former updates the formula part by part,
adding new parts if necessary:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">F1</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">x1</span> <span class="op">|</span> <span class="va">.</span> <span class="op">+</span> <span class="va">x1</span><span class="op">)</span></span>
<span><span class="co">## log(y1) ~ x2 | I(x1^2) + x1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">F1</span>, <span class="va">.</span> <span class="op">+</span> <span class="va">y2</span> <span class="op">|</span> <span class="va">y3</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span><span class="co">## log(y1) + y2 | y3 ~ x1 + x2 | I(x1^2)</span></span></code></pre></div>
<p>The <code><a href="../reference/Formula.html">as.Formula()</a></code> method coerces to
<code>"Formula"</code>, possibly also processing multiple arguments:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Formula.html">as.Formula</a></span><span class="op">(</span><span class="va">y1</span> <span class="op">~</span> <span class="va">x1</span>, <span class="va">y2</span> <span class="op">~</span> <span class="va">x2</span>, <span class="op">~</span> <span class="va">x3</span><span class="op">)</span></span>
<span><span class="co">## y1 | y2 ~ x1 | x2 | x3</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="sec:usage">Usage in model fitting functions<a class="anchor" aria-label="anchor" href="#sec:usage"></a>
</h2>
<p>A typical application of <strong>Formula</strong> is to provide the
workhorse for formula processing in model-fitting functions that require
specification of multiple parts or multiple responses. To provide a very
brief and simple example, we show how such a function can be set up. For
illustration, we compute the coefficients in an instrumental variables
regression using two-stage least squares.</p>
<p>The <code>ivcoef()</code> function below takes the usual arguments
<code>formula</code>, <code>data</code>, <code>subset</code>, and
<code>na.action</code> (and further arguments <code>weights</code> and
<code>offset</code> could be included in the same way). The
<code>formula</code> should be a two-part formula like
<code>y ~ x1 + x2 | z1 + z2 + z3</code>. There is a single response on
the LHS, one RHS part with the regressors and a second RHS part with the
instruments. The function <code>ivcoef()</code> uses the typical
workflow of model-fitting functions and processes its arguments in the
following four steps: (1) process the call, (2) set up the model frame
(using the <code>"Formula"</code> method), (3) extract response and
regressors from the model frame, (4) estimate the model (by calling
<code><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit()</a></code> twice to compute the two-stage least squares
coefficients).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivcoef</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>, <span class="va">subset</span>, <span class="va">na.action</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">mf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.call.html" class="external-link">match.call</a></span><span class="op">(</span>expand.dots <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"formula"</span>, <span class="st">"data"</span>, <span class="st">"subset"</span>, <span class="st">"na.action"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mf</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">mf</span> <span class="op">&lt;-</span> <span class="va">mf</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">m</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Formula.html">Formula</a></span><span class="op">(</span><span class="va">formula</span><span class="op">)</span></span>
<span>  <span class="va">mf</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html" class="external-link">as.name</a></span><span class="op">(</span><span class="st">"model.frame"</span><span class="op">)</span></span>
<span>  <span class="va">mf</span><span class="op">$</span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">f</span></span>
<span>  <span class="va">mf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">mf</span>, <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html" class="external-link">model.response</a></span><span class="op">(</span><span class="va">mf</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">mf</span>, rhs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">mf</span>, rhs <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">xz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit</a></span><span class="op">(</span><span class="va">z</span>, <span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit</a></span><span class="op">(</span><span class="va">xz</span>, <span class="va">y</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The resulting function can then be applied easily (albeit not very
meaningfully) to the <code>dat</code> data frame:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ivcoef</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">|</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">## (Intercept)          x1 </span></span>
<span><span class="co">##   -0.169027   -1.260073</span></span></code></pre></div>
<p>The same coefficients can be derived along with all the usual
inference using the <code>ivreg()</code> function from the
<strong>AER</strong> package <span class="citation">(Kleiber and Zeileis
2008)</span>, which also uses the <strong>Formula</strong> tools in its
latest release. Apart from providing inference and many other details,
<code>ivreg()</code> also supports <code>weights</code>,
<code>offsets</code> etc. Finally, for backward compatibility, the
function also allows separate formulas for regressors and instruments
(i.e., <code>formula = y ~ x1 + x2</code> and
<code>instruments = ~ z1 + z2 + z3</code>) which can be easily
incorporated using the <strong>Formula</strong> tools, e.g., replacing
<code>f &lt;- Formula(formula)</code> by</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(instruments)) <span class="fu">as.Formula</span>(formula, instruments)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="fu">as.Formula</span>(formula)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(<span class="fu">length</span>(f), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))))</span></code></pre></div>
<p>In summary, the usage of <strong>Formula</strong> should reduce the
overhead for the developers of model-fitting functions in R with
multiple responses and/or multiple parts and make the resulting programs
more intelligible. Further R packages employing the
<code>"Formula"</code> approach can be obtained from CRAN, including
<strong>betareg</strong>, <strong>frontier</strong>,
<strong>mlogit</strong>, and <strong>plm</strong>.</p>
</div>
<div class="section level2">
<h2 id="sec:summary">Summary<a class="anchor" aria-label="anchor" href="#sec:summary"></a>
</h2>
<p>The <strong>Formula</strong> package provides tools for processing
multi-response and multi-part formulas in the R system for statistical
computing. The new class <code>"Formula"</code> inherits from the
existing <code>"formula"</code> class, only adds a single new formula
operator <code>|</code>, and enables the usage of formula operators on
the left-hand side of formulas. The methods provided for
<code>"Formula"</code> objects are as similar as possible to the classic
methods, facilitating their usage in model-fitting functions that
require support for multiple responses and/or multiple parts of
variables.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Formula:Chambers+Hastie:1992" class="csl-entry">
Chambers, John M., and Trevor J. Hastie, eds. 1992. <em>Statistical
Models in <span>S</span></em>. London: Chapman &amp; Hall.
</div>
<div id="ref-Formula:Coelli+Henningsen:2010" class="csl-entry">
Coelli, Tim, and Arne Henningsen. 2010. <em><span class="nocase">frontier</span>: Stochastic Frontier Analysis</em>. <a href="https://CRAN.R-project.org/package=frontier" class="external-link">https://CRAN.R-project.org/package=frontier</a>.
</div>
<div id="ref-Formula:Cribari-Neto+Zeileis:2010" class="csl-entry">
Cribari-Neto, Francisco, and Achim Zeileis. 2010. <span>“Beta Regression
in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 34
(2): 1–24. <a href="https://doi.org/10.18637/jss.v034.i02" class="external-link">https://doi.org/10.18637/jss.v034.i02</a>.
</div>
<div id="ref-Formula:Croissant:2010" class="csl-entry">
Croissant, Yves. 2010. <em><span class="nocase">mlogit</span>:
Multinomial Logit Model</em>. <a href="https://CRAN.R-project.org/package=mlogit" class="external-link">https://CRAN.R-project.org/package=mlogit</a>.
</div>
<div id="ref-Formula:Croissant+Millo:2008" class="csl-entry">
Croissant, Yves, and Giovanni Millo. 2008. <span>“Panel Data
Econometrics in <span>R</span>: The <span class="nocase">plm</span>
Package.”</span> <em>Journal of Statistical Software</em> 27 (2): 1–43.
<a href="https://doi.org/10.18637/jss.v027.i02" class="external-link">https://doi.org/10.18637/jss.v027.i02</a>.
</div>
<div id="ref-Formula:Hothorn+Hornik+VanDeWiel:2006" class="csl-entry">
Hothorn, Torsten, Kurt Hornik, Mark A. van de Wiel, and Achim Zeileis.
2006. <span>“A <span>L</span>ego System for Conditional
Inference.”</span> <em>The American Statistician</em> 60 (3): 257–63.
</div>
<div id="ref-Formula:Hothorn+Hornik+VanDeWiel:2008" class="csl-entry">
———. 2008. <span>“Implementing a Class of Permutation Tests: The <span class="nocase">coin</span> Package.”</span> <em>Journal of Statistical
Software</em> 28 (8): 1–23. <a href="https://doi.org/10.18637/jss.v028.i08" class="external-link">https://doi.org/10.18637/jss.v028.i08</a>.
</div>
<div id="ref-Formula:Kleiber+Zeileis:2008" class="csl-entry">
Kleiber, Christian, and Achim Zeileis. 2008. <em>Applied Econometrics
with <span>R</span></em>. New York: Springer-Verlag.
</div>
<div id="ref-Formula:R:2009" class="csl-entry">
R Core Team. 2009. <em><span>R</span>: <span>A</span> Language and
Environment for Statistical Computing</em>. Vienna, Austria:
<span>R</span> Foundation for Statistical Computing. <a href="https://www.R-project.org/" class="external-link">https://www.R-project.org/</a>.
</div>
<div id="ref-Formula:Stasinopoulos+Rigby:2007" class="csl-entry">
Stasinopoulos, D. Mikis, and Robert A. Rigby. 2007. <span>“Generalized
Additive Models for Location Scale and Shape (<span>GAMLSS</span>) in
<span>R</span>.”</span> <em>Journal of Statistical Software</em> 23 (7):
1–46. <a href="https://doi.org/10.18637/jss.v023.i07" class="external-link">https://doi.org/10.18637/jss.v023.i07</a>.
</div>
<div id="ref-Formula:Wilkinson+Rogers:1973" class="csl-entry">
Wilkinson, G. N., and C. E. Rogers. 1973. <span>“Symbolic Description of
Factorial Models for Analysis of Variance.”</span> <em>Applied
Statistics</em> 22: 392–99.
</div>
<div id="ref-Formula:Zeileis+Croissant:2010" class="csl-entry">
Zeileis, Achim, and Yves Croissant. 2010. <span>“Extended Model Formulas
in <span>R</span>: Multiple Parts and Multiple Responses.”</span>
<em>Journal of Statistical Software</em> 34 (1): 1–13. <a href="https://doi.org/10.18637/jss.v034.i01" class="external-link">https://doi.org/10.18637/jss.v034.i01</a>.
</div>
<div id="ref-Formula:Zeileis+Hothorn+Hornik:2008" class="csl-entry">
Zeileis, Achim, Torsten Hothorn, and Kurt Hornik. 2008.
<span>“Model-Based Recursive Partitioning.”</span> <em>Journal of
Computational and Graphical Statistics</em> 17 (2): 492–514.
</div>
<div id="ref-Formula:Zeileis+Kleiber+Jackman:2008" class="csl-entry">
Zeileis, Achim, Christian Kleiber, and Simon Jackman. 2008.
<span>“Regression Models for Count Data in <span>R</span>.”</span>
<em>Journal of Statistical Software</em> 27 (8): 1–25. <a href="https://doi.org/10.18637/jss.v027.i08" class="external-link">https://doi.org/10.18637/jss.v027.i08</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Achim Zeileis, Yves Croissant.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
